name: Publish

on:
  push:
    tags:
      - '*'

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Run package.sh
      run: |
        chmod +x bin/package.sh
        ./bin/package.sh

    - name: Find new tar.xz file
      run: |
        NEW_FILE_NAME=$(git ls-files --others --exclude-standard | grep '\.tar\.xz$')
        echo "NEW_FILE_NAME=$NEW_FILE_NAME" >> $GITHUB_ENV

    - name: Calculate SHA256
      run: |
        echo "SHA256_SUM=$(sha256sum ${{ env.NEW_FILE_NAME }} | awk '{ print $1 }')" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-files
        path: |
          ${{ env.NEW_FILE_NAME }}
          ${{ env.NEW_FILE_NAME }}.sha256sum

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-files

    - name: Create draft release
      run: |
        VERSION=$(cat VERSION)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        gh release create $VERSION --draft --title "Release $VERSION" --notes "SHA256: ${{ env.SHA256_SUM }}" 
        --repo ${{ github.repository }} *.tar.xz *.sha256sum
      env:
        GH_TOKEN: ${{ github.token }}
